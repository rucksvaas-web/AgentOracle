<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SmartStudy Portal</title>
  <meta name="theme-color" content="#2b6cb0" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%232b6cb0'/%3E%3Ctext x='50' y='57' font-size='42' text-anchor='middle' fill='white' font-family='Arial'%3ESS%3C/text%3E%3C/svg%3E" />
  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- Optional lazy OCR (only loaded when user enables OCR) -->
  <style>
    :root{
      --primary:#2b6cb0; --accent:#2c5282; --bg:#f7fafc; --card:#ffffff; --muted:#556; --radius:12px;
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      -webkit-font-smoothing:antialiased;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#e6eef8);color:#0f172a;min-height:100vh;-webkit-tap-highlight-color:transparent}
    header{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--card);box-shadow:0 6px 18px rgba(44,82,130,0.06);position:sticky;top:0;z-index:20}
    .logo{width:46px;height:46px;border-radius:10px;background:var(--primary);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;flex:0 0 46px}
    .title{font-size:18px;font-weight:700}
    .container{max-width:1100px;margin:18px auto;padding:0 14px}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
    .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 6px 18px rgba(11,22,39,0.04)}
    .launcher-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .tile{background:linear-gradient(180deg,#fff,#f3f8ff);border-radius:10px;padding:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;min-height:84px;cursor:pointer;border:1px solid rgba(44,82,130,0.06);user-select:none}
    .tile img{width:36px;height:36px;border-radius:6px;object-fit:cover}
    .tile .label{font-size:13px;color:var(--muted);text-align:center;word-break:break-word}
    .controls{display:flex;gap:8px;align-items:center}
    button{background:var(--primary);color:#fff;border:none;padding:8px 10px;border-radius:10px;font-weight:600;cursor:pointer}
    .muted-btn{background:transparent;color:var(--accent);border:1px solid rgba(44,82,130,0.08)}
    .small{font-size:13px;padding:6px 8px}
    .section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    input[type=text],textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid #e2e8f0;font-size:14px}
    .tools-list{display:flex;flex-direction:column;gap:8px}
    .dropzone{border:2px dashed rgba(44,82,130,0.08);padding:12px;border-radius:10px;text-align:center;color:var(--muted);background:linear-gradient(180deg,rgba(255,255,255,0.6),transparent)}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .thumb{width:92px;height:120px;border-radius:10px;border:1px solid rgba(11,22,39,0.04);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px;position:relative;background:#fff}
    .thumb img{max-width:84px;max-height:72px;border-radius:6px;object-fit:cover}
    .thumb .tlabel{font-size:12px;color:var(--muted);margin-top:6px;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:84px}
    .thumb .remove{position:absolute;top:6px;right:6px;background:#fff;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;border:1px solid rgba(44,82,130,0.06);cursor:pointer}
    .notes{min-height:140px}
    footer{max-width:1100px;margin:18px auto;padding:10px 14px;color:var(--muted);font-size:13px}
    .hint{font-size:13px;color:var(--muted)}
    /* Mobile friendliness */
    @media(max-width:980px){.grid{grid-template-columns:1fr;}.launcher-grid{grid-template-columns:repeat(3,1fr)}.card{padding:12px}}
    @media(max-width:520px){.launcher-grid{grid-template-columns:repeat(2,1fr)}header{padding:10px}}
  </style>
</head>
<body>
  <header>
    <div class="logo">SS</div>
    <div style="flex:0 1 auto">
      <div class="title">SmartStudy Portal</div>
      <div style="font-size:12px;color:var(--muted)">Multi‑App Launcher • Document Converter • Student Toolkit</div>
    </div>
    <div style="flex:1"></div>
    <div class="controls">
      <button id="addTileBtn" class="small muted-btn">+ Shortcut</button>
      <button id="openConverter" class="small">Converter</button>
    </div>
  </header>

  <main class="container">
    <div class="grid">
      <section class="card" aria-labelledby="launcher-heading">
        <div class="section-title"><h3 id="launcher-heading">Launcher</h3><div class="hint">Tap to open • Long‑press to edit • Drag to reorder</div></div>
        <div class="launcher-grid" id="launcherGrid" role="list">
          <!-- tiles -->
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <button id="editMode" class="small muted-btn">Reorder Mode</button>
          <button id="resetTiles" class="small muted-btn">Reset</button>
        </div>
      </section>

      <aside class="card" aria-labelledby="tools-heading">
        <div class="section-title"><h3 id="tools-heading">Quick Tools</h3><div class="hint">Handy study helpers</div></div>
        <div class="tools-list">
          <div style="display:flex;gap:8px;flex-wrap:wrap"><button id="openNotes" class="small muted-btn">Notes</button><button id="openTodo" class="small muted-btn">To‑Do</button><button id="openTimetable" class="small muted-btn">Timetable</button></div>
          <div style="display:flex;gap:8px;margin-top:8px"><button id="openCalc" class="small muted-btn">Calculator</button><button id="exportConfig" class="small">Export</button><button id="importConfig" class="small muted-btn">Import</button></div>
          <div style="margin-top:10px"><label class="hint"><input type="checkbox" id="enableOCR"> Enable OCR (lazy-load heavy library)</label></div>
        </div>
      </aside>
    </div>

    <div style="height:16px"></div>

    <section class="card" id="converterCard" aria-labelledby="converter-heading">
      <div class="section-title"><h3 id="converter-heading">Document Converter</h3>
        <div style="display:flex;gap:8px">
          <button data-tab="images" class="tabBtn small muted-btn">Images → PDF</button>
          <button data-tab="text" class="tabBtn small muted-btn">Text → PDF</button>
          <button data-tab="html" class="tabBtn small muted-btn">HTML → PDF</button>
          <button data-tab="merge" class="tabBtn small muted-btn">Merge PDFs</button>
        </div>
      </div>

      <div id="panelImages" class="panel">
        <div class="dropzone" id="imageDrop">Drop images here or <label style="color:var(--accent);cursor:pointer"><input id="imageInput" type="file" accept="image/*" multiple style="display:none">choose files</label></div>
        <div class="thumbs" id="thumbs" aria-live="polite"></div>
        <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label style="display:flex;align-items:center;gap:6px">Quality<select id="imgQuality"><option value="0.9">High</option><option value="0.7">Medium</option><option value="0.5">Small</option></select></label>
          <label>Filename: <input id="pdfName" type="text" value="smartstudy_document" style="width:180px"></label>
          <button id="makePdf" class="small">Create PDF</button>
          <button id="clearImages" class="small muted-btn">Clear</button>
        </div>
      </div>

      <div id="panelText" class="panel" style="display:none;margin-top:12px">
        <textarea id="textInput" class="notes" placeholder="Paste notes or type assignment text here"></textarea>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center"><input id="textPdfName" type="text" value="notes_document"><button id="textToPdf" class="small">Save as PDF</button></div>
      </div>

      <div id="panelHtml" class="panel" style="display:none;margin-top:12px">
        <div class="hint">Paste a simple HTML fragment or note; we render and snapshot it.</div>
        <textarea id="htmlInput" class="notes" placeholder="Paste or write HTML (simple) here"></textarea>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center"><input id="htmlPdfName" type="text" value="page_snapshot"><button id="htmlToPdf" class="small">Export to PDF</button></div>
      </div>

      <div id="panelMerge" class="panel" style="display:none;margin-top:12px">
        <div class="hint">Select multiple PDF files to merge client-side.</div>
        <input id="mergeInput" type="file" accept="application/pdf" multiple>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center"><input id="mergePdfName" type="text" value="merged_document"><button id="mergePdfsBtn" class="small">Merge PDFs</button></div>
      </div>

    </section>

    <div style="height:16px"></div>

    <div class="card">
      <div class="section-title"><h3>Extras</h3><div class="hint">Notes • To‑Do • Timetable</div></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <div style="font-weight:700;margin-bottom:8px">Notes</div>
          <textarea id="notesArea" class="notes" placeholder="Quick class notes — saved locally"></textarea>
        </div>
        <div>
          <div style="font-weight:700;margin-bottom:8px">To‑Do (assignments)</div>
          <div style="display:flex;gap:8px;margin-bottom:8px"><input id="todoInput" type="text" placeholder="Add assignment"><button id="addTodo" class="small">Add</button></div>
          <div id="todoList" style="min-height:120px"></div>
        </div>
      </div>
    </div>

  </main>

  <footer>Made with ♥ for students — SmartStudy Portal. Data stays on your device. Convert to an APK using Median or any WebView wrapper.</footer>

  <script>
  (async function(){
    // Keys
    const KEY_TILES='ss_tiles_v2'; const KEY_NOTES='ss_notes_v2'; const KEY_TODO='ss_todo_v2';

    // Defaults
    const defaultTiles = [
      {id:1,label:'Google',url:'https://www.google.com',icon:'https://www.google.com/favicon.ico'},
      {id:2,label:'Classroom',url:'https://classroom.google.com',icon:'https://classroom.google.com/favicon.ico'},
      {id:3,label:'Drive',url:'https://drive.google.com',icon:'https://drive.google.com/favicon.ico'},
      {id:4,label:'YouTube',url:'https://www.youtube.com',icon:'https://www.youtube.com/favicon.ico'},
      {id:5,label:'ChatGPT',url:'https://chat.openai.com',icon:'https://chat.openai.com/favicon.ico'},
      {id:6,label:'Wikipedia',url:'https://www.wikipedia.org',icon:'https://www.wikipedia.org/static/favicon/wikipedia.ico'},
    ];

    // DOM
    const byId=id=>document.getElementById(id);
    const grid=byId('launcherGrid');

    // storage helpers
    const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
    const load=(k,def)=>{const v=localStorage.getItem(k);return v?JSON.parse(v):def};

    let tiles = load(KEY_TILES, defaultTiles.slice());
    let reorderMode=false;

    // render
    function renderTiles(){grid.innerHTML='';tiles.forEach((t,i)=>{
      const el=document.createElement('div');el.className='tile';el.draggable=true;el.dataset.id=t.id;el.role='listitem';
      const iconSrc = t.icon || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\'%3E%3Cpath fill=\'%232c5282\' d=\'M12 2L2 7v6c0 5 5 9 10 9s10-4 10-9V7l-10-5z\'/%3E%3C/svg%3E';
      el.innerHTML=`<div style="width:100%;display:flex;align-items:center;justify-content:center"><img src="${iconSrc}" alt="${escapeHtml(t.label)} icon"></div><div class="label">${escapeHtml(t.label)}</div>`;

      // click
      el.addEventListener('click',()=>{if(reorderMode) return; try{window.open(t.url,'_self')}catch(e){window.location.href=t.url}});

      // long-press (touch friendly)
      let longpressTimer;
      el.addEventListener('pointerdown',e=>{longpressTimer=setTimeout(()=>{editTile(i)},600)});
      el.addEventListener('pointerup',()=>clearTimeout(longpressTimer));
      el.addEventListener('pointerleave',()=>clearTimeout(longpressTimer));

      // drag handlers
      el.addEventListener('dragstart',ev=>{ev.dataTransfer.setData('text/plain',i);el.style.opacity='0.6'});
      el.addEventListener('dragend',()=>{el.style.opacity=''});

      grid.appendChild(el);
    });}

    function escapeHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

    renderTiles();

    // Add / Edit / Reset
    byId('addTileBtn').addEventListener('click',()=>{
      const label=prompt('Shortcut label'); if(!label) return; const url=prompt('Full URL (https://...)', 'https://'); if(!url) return; const icon=prompt('Icon URL (optional)'); const id=Date.now(); tiles.push({id,label,url,icon}); save(KEY_TILES,tiles); renderTiles();
    });
    byId('resetTiles').addEventListener('click',()=>{if(confirm('Reset launcher to defaults?')){tiles=defaultTiles.slice();save(KEY_TILES,tiles);renderTiles()}});
    byId('editMode').addEventListener('click',()=>{reorderMode=!reorderMode;byId('editMode').textContent=reorderMode? 'Done' : 'Reorder Mode';grid.style.cursor=reorderMode? 'grabbing':'default'});

    function editTile(index){const t=tiles[index];if(!t) return;const label=prompt('Label',t.label); if(label!=null) t.label=label; const url=prompt('URL',t.url); if(url!=null) t.url=url; const icon=prompt('Icon URL',t.icon||''); if(icon!=null) t.icon=icon; save(KEY_TILES,tiles); renderTiles();}

    // Drag reordering (grid-level)
    grid.addEventListener('dragover',e=>e.preventDefault());
    grid.addEventListener('drop',e=>{
      e.preventDefault();const fromIndex = +e.dataTransfer.getData('text/plain');
      // find drop index
      const nodes = Array.from(grid.children); let toIndex = nodes.length-1;
      for(let i=0;i<nodes.length;i++){const r=nodes[i].getBoundingClientRect(); if(e.clientY < r.top + r.height/2){toIndex = i; break}}
      // move
      const [item] = tiles.splice(fromIndex,1); tiles.splice(toIndex,0,item); save(KEY_TILES,tiles); renderTiles();
    });

    // --- Converter: images -> PDF with safe image handling ---
    const imageInput=byId('imageInput'),thumbs=byId('thumbs'),imageDrop=byId('imageDrop'),pdfName=byId('pdfName'),imgQuality=byId('imgQuality');
    let images = load('ss_images_v1', []);

    function saveImages(){localStorage.setItem('ss_images_v1', JSON.stringify(images.slice(0,50)));}

    function renderThumbs(){thumbs.innerHTML='';images.forEach((it,idx)=>{
      const el=document.createElement('div');el.className='thumb';el.dataset.idx=idx;
      el.innerHTML=`<div class="remove" title="Remove">×</div><img alt="image ${idx}"><div class="tlabel">${escapeHtml(it.name)}</div>`;
      const imgEl=el.querySelector('img');
      imgEl.src = it.data; imgEl.onerror = ()=>{imgEl.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\'%3E%3Cpath fill=\'%232c5282\' d=\'M12 2L2 7v6c0 5 5 9 10 9s10-4 10-9V7l-10-5z\'/%3E%3C/svg%3E'};
      el.querySelector('.remove').addEventListener('click',()=>{images.splice(idx,1);saveImages();renderThumbs()});
      // drag reorder within thumbs (mobile friendly)
      el.draggable=true; el.addEventListener('dragstart',ev=>ev.dataTransfer.setData('text/plain',idx));
      el.addEventListener('dragover',e=>e.preventDefault());
      el.addEventListener('drop',e=>{e.preventDefault();const from=+e.dataTransfer.getData('text/plain');const to=+el.dataset.idx;const [m]=images.splice(from,1);images.splice(to,0,m);saveImages();renderThumbs()});
      thumbs.appendChild(el);
    })}
    renderThumbs();

    // Limit and compress when adding images to avoid OOM on old Android devices
    function addFiles(files){const maxFiles = 30; const remaining = Math.max(0, maxFiles - images.length); const list = Array.from(files).slice(0,remaining);
      list.forEach(file=>{ if(!file.type.startsWith('image')) return; const reader=new FileReader(); reader.onerror=()=>alert('Failed to read '+file.name);
        reader.onload = async (e)=>{
          try{ // compress by drawing to canvas
            const dataUrl = e.target.result;
            const img = await loadImageSafe(dataUrl);
            const maxW = 1200; const maxH = 1600; let w=img.width, h=img.height; const ratio = Math.min(1, Math.min(maxW/w, maxH/h)); w = Math.round(w*ratio); h = Math.round(h*ratio);
            const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h; const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
            const quality = parseFloat(imgQuality.value) || 0.8; const compressed = canvas.toDataURL('image/jpeg', quality);
            images.push({name:file.name, data:compressed}); saveImages(); renderThumbs();
          }catch(err){console.error('image add err',err);alert('Error processing image '+file.name)}
        };
        reader.readAsDataURL(file);
      });}

    imageInput.addEventListener('change',e=>addFiles(e.target.files));
    imageDrop.addEventListener('dragover',e=>{e.preventDefault();imageDrop.style.borderColor='rgba(44,82,130,0.18)'});
    imageDrop.addEventListener('dragleave',()=>{imageDrop.style.borderColor=''});
    imageDrop.addEventListener('drop',e=>{e.preventDefault();imageDrop.style.borderColor='';addFiles(e.dataTransfer.files)});
    byId('clearImages').addEventListener('click',()=>{images=[];saveImages();renderThumbs()});

    // Create PDF safely using jsPDF but with image compression and page breaks
    async function createPdfFromImages(){if(images.length===0){alert('Add images first');return}
      const { jsPDF } = window.jspdf; const doc = new jsPDF({unit:'px',format:'a4'});
      const maxW = 595; const maxH = 842; for(let i=0;i<images.length;i++){
        const item = images[i]; try{
          const img = await loadImageSafe(item.data);
          let iw = img.width, ih = img.height; const scale = Math.min(maxW/iw, maxH/ih, 1); const w = iw*scale; const h = ih*scale;
          if(i>0) doc.addPage();
          doc.addImage(item.data,'JPEG', (maxW-w)/2, 40, w, h);
          doc.setFontSize(10); doc.setTextColor(120); doc.text(`${i+1} / ${images.length}`, 40, 820);
        }catch(err){console.warn('Skipping image',item.name,err)}
      }
      const name = (pdfName.value || 'smartstudy_document') + '.pdf'; doc.save(name);
    }

    byId('makePdf').addEventListener('click',createPdfFromImages);

    // helper to load image with cross-origin and error handling
    function loadImageSafe(src){return new Promise((res,rej)=>{const i=new Image();i.onload=()=>res(i);i.onerror=()=>rej(new Error('image load error'));i.src=src})}

    // Text -> PDF (improved pagination and font sizing)
    byId('textToPdf').addEventListener('click',()=>{
      const text = byId('textInput').value.trim(); if(!text){alert('Write or paste some text first');return}
      const { jsPDF } = window.jspdf; const doc = new jsPDF(); const margin=20; const pageW=doc.internal.pageSize.getWidth()-margin*2; doc.setFontSize(12);
      const lines = doc.splitTextToSize(text, pageW); let cursor=margin+10; const lineHeight=14;
      for(let i=0;i<lines.length;i++){
        if(cursor + lineHeight > doc.internal.pageSize.getHeight()-margin){doc.addPage(); cursor = margin+10}
        doc.text(lines[i], margin, cursor); cursor += lineHeight;
      }
      doc.save((byId('textPdfName').value||'notes')+'.pdf');
    });

    // HTML -> PDF using html2canvas with cleanup
    byId('htmlToPdf').addEventListener('click',async ()=>{
      const html = byId('htmlInput').value.trim(); if(!html){alert('Paste some HTML first');return}
      const wrap = document.createElement('div');wrap.style.padding='20px';wrap.style.background='#fff';wrap.style.maxWidth='800px';wrap.innerHTML = html; document.body.appendChild(wrap);
      try{const canvas = await html2canvas(wrap, {scale:1.6}); const img = canvas.toDataURL('image/jpeg',0.9); const { jsPDF } = window.jspdf; const doc = new jsPDF({unit:'px',format:'a4'});
        const iw=canvas.width, ih=canvas.height; const maxW=595, maxH=842; const scale=Math.min(maxW/iw, maxH/ih); const w=iw*scale, h=ih*scale; doc.addImage(img,'JPEG',(maxW-w)/2,20,w,h); doc.save((byId('htmlPdfName').value||'page')+'.pdf');
      }catch(err){console.error(err);alert('Failed to export HTML to PDF') } finally{document.body.removeChild(wrap)}
    });

    // Merge PDFs client-side (using simple concatenation via ArrayBuffer + PDFLib?)
    // We will use a lightweight approach: if PDFLib present, use it; otherwise simple fallback to download selected files individually
    async function mergePdfs(files){ if(files.length===0) return alert('Pick PDF files');
      // try to use PDFLib if available
      if(window.PDFLib){ try{
        const { PDFDocument } = PDFLib; const mergedDoc = await PDFDocument.create();
        for(const f of files){ const arr = await f.arrayBuffer(); const donor = await PDFDocument.load(arr); const copied = await mergedDoc.copyPages(donor, donor.getPageIndices()); copied.forEach(p=>mergedDoc.addPage(p)); }
        const merged = await mergedDoc.save(); const blob = new Blob([merged],{type:'application/pdf'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=(byId('mergePdfName').value||'merged')+'.pdf'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); return;
      }catch(err){console.error(err)} }
      // fallback: simply prompt to download first selected (no merge)
      alert('PDF merge requires a merging library (PDFLib). In this build, either include PDFLib or merge externally.');
    }
    byId('mergePdfsBtn').addEventListener('click',()=>{const f=byId('mergeInput').files; mergePdfs(Array.from(f))});

    // Extras: Notes and ToDo
    const notesArea=byId('notesArea'); notesArea.value = load(KEY_NOTES,''); notesArea.addEventListener('input',()=>save(KEY_NOTES,notesArea.value));
    let todos = load(KEY_TODO,[]);
    function renderTodos(){const list=byId('todoList'); list.innerHTML=''; todos.forEach((t,i)=>{const r=document.createElement('div'); r.style.display='flex'; r.style.justifyContent='space-between'; r.style.alignItems='center'; r.style.padding='6px 0'; r.innerHTML=`<div style="display:flex;gap:8px;align-items:center"><input type="checkbox" ${t.done? 'checked':''} data-i="${i}"><div style="max-width:200px;overflow:hidden;text-overflow:ellipsis">${escapeHtml(t.text)}</div></div><div><button data-i="${i}" class="small muted-btn">Del</button></div>`; r.querySelector('input').addEventListener('change',ev=>{todos[i].done=ev.target.checked; save(KEY_TODO,todos); renderTodos()}); r.querySelector('button').addEventListener('click',()=>{todos.splice(i,1); save(KEY_TODO,todos); renderTodos()}); list.appendChild(r)})}
    renderTodos(); byId('addTodo').addEventListener('click',()=>{const v=byId('todoInput').value.trim(); if(!v) return; todos.push({text:v,done:false}); save(KEY_TODO,todos); byId('todoInput').value=''; renderTodos();});

    // Export / Import
    byId('exportConfig').addEventListener('click',()=>{const payload={tiles,notes:notesArea.value,todos,images}; const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='smartstudy_export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url)});
    byId('importConfig').addEventListener('click',()=>{const input=document.createElement('input'); input.type='file'; input.accept='application/json'; input.addEventListener('change',ev=>{const f=ev.target.files[0]; const r=new FileReader(); r.onload=e=>{try{const obj=JSON.parse(e.target.result); if(obj.tiles) tiles=obj.tiles; if(obj.notes) notesArea.value=obj.notes; if(obj.todos) todos=obj.todos; if(obj.images) { images = obj.images.slice(0,50); saveImages(); } save(KEY_TILES,tiles); save(KEY_NOTES,notesArea.value); save(KEY_TODO,todos); renderTiles(); renderTodos(); renderThumbs(); alert('Imported') }catch(err){alert('Invalid file')} }; r.readAsText(f)}); input.click()});

    // Quick links
    byId('openNotes').addEventListener('click',()=>{notesArea.focus(); window.scrollTo({top:notesArea.getBoundingClientRect().top + window.scrollY - 80, behavior:'smooth'})});
    byId('openTodo').addEventListener('click',()=>{window.scrollTo({top:byId('todoList').getBoundingClientRect().top + window.scrollY - 80, behavior:'smooth'})});
    byId('openConverter').addEventListener('click',()=>{window.location.hash='converter'; window.scrollTo({top:byId('converterCard').offsetTop-60, behavior:'smooth'})});
    byId('openTimetable').addEventListener('click',()=>{alert('Timetable coming soon — we can add editable timetable & class reminders.')});
    byId('openCalc').addEventListener('click',()=>{const q=prompt('Enter expression to calculate (e.g. 12/3 + 5*2)'); if(q!==null) try{alert('Result: '+eval(q))}catch(e){alert('Invalid expression')}});

    // Export saved state before unload
    window.addEventListener('beforeunload',()=>{save(KEY_TILES,tiles); save(KEY_NOTES,notesArea.value); save(KEY_TODO,todos); saveImages()});
    if(!localStorage.getItem(KEY_TILES)) save(KEY_TILES,tiles);

    // Tab switching
    const tabs = document.querySelectorAll('.tabBtn'); tabs.forEach(tb=>tb.addEventListener('click',()=>{const name=tb.dataset.tab; document.querySelectorAll('.panel').forEach(p=>p.style.display='none'); document.getElementById('panel'+capitalize(name)).style.display='block'})); function capitalize(s){return s.charAt(0).toUpperCase()+s.slice(1)}

    // OCR lazy-load (Tesseract) when user enables
    byId('enableOCR').addEventListener('change',async (e)=>{
      if(e.target.checked){ if(!window.Tesseract){ const script=document.createElement('script'); script.src='https://cdn.jsdelivr.net/npm/tesseract.js@v2.1.5/dist/tesseract.min.js'; document.head.appendChild(script); script.onload=()=>alert('OCR loaded — you can paste images and use third-party OCR actions (we can add OCR UI next).'); } }
    });

    // Utility: load external PDFLib lazily if user tries to merge PDFs
    // (we don't load heavy libs until user chooses feature)

    // small utility functions
    function capitalizeFirst(s){return s.charAt(0).toUpperCase()+s.slice(1)}

    // merge PDF import (lazy)
    byId('mergeInput').addEventListener('change',async (e)=>{/* files selected */});

    // keyboard shortcuts
    window.addEventListener('keydown',(e)=>{if(e.key==='/' && (e.ctrlKey||e.metaKey)){e.preventDefault(); imageInput.click()}})

  })();
  </script>
</body>
</html>
